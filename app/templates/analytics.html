{% extends 'base.html' %}
{% block content %}
<h1 class="text-2xl font-bold mb-4">Analytics</h1>
<div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-4">
  <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow"><div class="text-xs">Online / Total</div><div class="text-2xl font-bold">{{kpi.online_agents}} / {{kpi.total_agents}}</div></div>
  <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow"><div class="text-xs">Deployments 24h</div><div class="text-2xl font-bold">{{kpi.deployments_24h}}</div></div>
  <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow"><div class="text-xs">Error rate /1000</div><div class="text-2xl font-bold">{{kpi.error_rate_per_1000}}</div></div>
  <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow"><div class="text-xs">Avg latency</div><div class="text-2xl font-bold">{{kpi.avg_latency}} ms</div></div>
</div>
<div class="flex justify-end mb-3"><a href="/api/telemetry/export.csv?range=24h" class="bg-indigo-600 text-white px-3 py-2 rounded">Export CSV</a></div>
<div class="grid lg:grid-cols-2 gap-4">
  <div class="bg-white dark:bg-slate-800 rounded-xl p-4 shadow"><canvas id="traffic"></canvas></div>
  <div class="bg-white dark:bg-slate-800 rounded-xl p-4 shadow"><canvas id="latency"></canvas></div>
  <div class="bg-white dark:bg-slate-800 rounded-xl p-4 shadow"><canvas id="actions"></canvas></div>
  <div class="bg-white dark:bg-slate-800 rounded-xl p-4 shadow"><canvas id="profiles"></canvas></div>
  <div class="bg-white dark:bg-slate-800 rounded-xl p-4 shadow lg:col-span-2"><canvas id="topErrors"></canvas></div>
</div>
<div class="mt-4 bg-white dark:bg-slate-800 rounded-xl p-4 shadow overflow-auto"><h3 class="font-semibold mb-2">Latest events (audit + telemetry)</h3><table class="w-full text-sm"><tr><th>Time</th><th>Type</th><th>Action</th><th>Details</th></tr>{% for e in events %}<tr class="border-t"><td>{{e.ts}}</td><td>{{e.type}}</td><td>{{e.action}}</td><td>{{e.details}}</td></tr>{% endfor %}</table></div>
<script>
Promise.all([
fetch('/api/metrics/traffic?range=1h').then(r=>r.json()),
fetch('/api/metrics/latency?range=1h').then(r=>r.json()),
fetch('/api/metrics/actions?range=24h').then(r=>r.json()),
fetch('/api/metrics/profile_distribution?range=7d').then(r=>r.json()),
fetch('/api/metrics/top_errors?range=24h').then(r=>r.json())
]).then(([traffic,latency,actions,profiles,errs])=>{
new Chart(document.getElementById('traffic'), {type:'line', data:{labels:traffic.map(x=>x.ts.slice(11)), datasets:[{label:'in', data:traffic.map(x=>x.bytes_in)},{label:'out', data:traffic.map(x=>x.bytes_out)}]}})
new Chart(document.getElementById('latency'), {type:'line', data:{labels:latency.map(x=>x.ts.slice(11)), datasets:[{label:'latency', data:latency.map(x=>x.latency_ms)}]}})
new Chart(document.getElementById('actions'), {type:'bar', data:{labels:Object.keys(actions), datasets:[{label:'actions', data:Object.values(actions)}]}})
new Chart(document.getElementById('profiles'), {type:'pie', data:{labels:profiles.map(x=>x.label), datasets:[{data:profiles.map(x=>x.value)}]}})
new Chart(document.getElementById('topErrors'), {type:'bar', data:{labels:errs.map(x=>x.agent), datasets:[{label:'errors', data:errs.map(x=>x.errors)}]}})
})
</script>
{% endblock %}
